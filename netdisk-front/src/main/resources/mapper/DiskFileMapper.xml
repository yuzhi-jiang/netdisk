<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yefeng.netdisk.front.mapper.DiskFileMapper">


    <sql id="selectFileBo">
        select tdf.id,
               tdf.disk_id,
               tdf.file_id,
               tdf.file_name,
               tdf.parent_file_id,

               tf.length,

               tf.hash,
               tf.type,
               tf.status
        from tb_disk_file as tdf
                 join tb_file as tf
                      on tf.id = tdf.file_id
    </sql>

    <select id="getFileList" resultType="com.yefeng.netdisk.front.entity.DiskFile">
        select *
        from tb_disk_file as tdf
        where tdf.disk_id = #{diskId}
    </select>

    <sql id="fileVo">
        ${tf}.id,
            length ,
            `hash`,
            `path`,
            `status`,
        ${tdf}
        .
        file_name
        as
        `name`
    </sql>
    <select id="selectFilePathByDiskIDAndFileId" resultType="com.yefeng.netdisk.front.entity.DiskFile">
        SELECT df.*
        FROM (SELECT @r                                                                      AS disk_file_id,
                     (SELECT @r := parent_file_id FROM tb_disk_file WHERE disk_file_id = @r LIMIT 1) AS parent_file_id
              FROM (SELECT @r := #{disk_file_id}) vars,
                   tb_disk_file
              WHERE @r IS NOT NULL) T
                 JOIN tb_disk_file df ON T.disk_file_id = df.disk_file_id
        where disk_id = #{diskId}
    </select>

    <update id="deleteFile">
        delete tdf from tb_disk_file as tdf
        where
        tdf.disk_file_id in
        <foreach collection="fileIds" separator="," open="(" close=")" item="item">
            #{item}
        </foreach>
        and tdf.status=3
        and tdf.disk_id=#{diskId}
    </update>

    <update id="updateStatus">
        update tb_disk_file tdf
        set tdf.status=#{statusCode}
        where
        tdf.disk_file_id in
        <foreach collection="fileIds" separator="," open="(" close=")" item="item">
            #{item}
        </foreach>
        and
        tdf.disk_id=#{diskId}
    </update>
    <update id="moveFileBatch">

        <foreach collection="diskFiles" item="item" separator=";">
            update tb_disk_file set parent_file_id =#{item.parentFileId} where disk_file_id=#{item.diskFileId}
        </foreach>


    </update>
</mapper>
